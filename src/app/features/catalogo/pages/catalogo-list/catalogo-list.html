<div class="catalog-wrapper" [class.filters-open]="isFiltersOpen">
  <!-- Barra mÃ³vil -->
  <div class="mobile-filters-bar">
    <button
      #filtersButtonRef
      type="button"
      class="filters-toggle"
      (click)="openFilters()"
      aria-controls="catalog-filters"
      [attr.aria-expanded]="isFiltersOpen">
      Filtros
    </button>
  </div>

  <!-- Backdrop mÃ³vil -->
  <div class="filters-backdrop" *ngIf="isFiltersOpen" (click)="closeFilters()"></div>

  <!-- Sidebar de filtros -->
  <aside
    id="catalog-filters"
    class="filters-panel"
    [class.open]="isFiltersOpen"
    aria-label="Filtros">
    <form [formGroup]="filtersForm" class="filters-form">
      <!-- CategorÃ­a -->
      <div class="filters-section">
        <h3>CategorÃ­a</h3>
        <div class="option" *ngFor="let category of categoryOptions">
          <label>
            <input
              type="checkbox"
              [checked]="filtersForm.controls.categories.value.includes(category)"
              (change)="onCheckboxChange('categories', category, $event.target.checked)" />
            <span>{{ category }}</span>
          </label>
        </div>
      </div>

       <!-- Tipo de prenda -->
      <div class="filters-section">
        <h3>Tipo de prenda</h3>
        <div class="option" *ngFor="let subCategory of subCategoryOptions">
          <label>
            <input
              type="checkbox"
              [checked]="filtersForm.controls.subCategories.value.includes(subCategory)"
              (change)="onCheckboxChange('subCategories', subCategory, $event.target.checked)" />
            <span>{{ subCategory }}</span>
          </label>
        </div>
      </div>

      <!-- Talla -->
      <div class="filters-section">
        <h3>Talla</h3>
        <div class="option" *ngFor="let size of sizeOptions">
          <label>
            <input
              type="checkbox"
              [checked]="filtersForm.controls.sizes.value.includes(size)"
              (change)="onCheckboxChange('sizes', size, $event.target.checked)" />
            <span>{{ size }}</span>
          </label>
        </div>
      </div>

      <!-- Color -->
      <div class="filters-section">
        <h3>Color</h3>
        <div class="option" *ngFor="let color of colorOptions">
          <label>
            <input
              type="checkbox"
              [checked]="filtersForm.controls.colors.value.includes(color)"
              (change)="onCheckboxChange('colors', color, $event.target.checked)" />
            <span>{{ color }}</span>
          </label>
        </div>
      </div>

      <!-- Precio -->
      <div class="filters-section">
        <h3>Precio</h3>
        <div class="price-inputs">
          <label>
            <span>Min</span>
            <input type="number" formControlName="priceMin" min="0" (change)="onPriceChange()" />
          </label>
          <label>
            <span>Max</span>
            <input type="number" formControlName="priceMax" min="0" (change)="onPriceChange()" />
          </label>
        </div>
      </div>
      
    </form>
  </aside>

  <!-- Contenido principal -->
  <main class="catalog-content">
    <!-- chips de filtros aplicados -->
    <section class="applied-filters" *ngIf="appliedChips?.length">
      <button
        class="chip"
        *ngFor="let chip of appliedChips; trackBy: trackByChip"
        type="button"
        (click)="removeFilterChip(chip)">
        {{ chip.label }} âœ•
      </button>
      <button type="button" class="clear-all" (click)="clearFilters()">Limpiar filtros</button>
    </section>

    <!-- barra superior (orden) -->
    <section class="toolbar">
      <label>
        Ordenar por:
        <select [formControl]="filtersForm.controls['sort']" (change)="applyFilters()">
          <option value="relevance">Relevancia</option>
          <option value="priceAsc">Precio â†‘</option>
          <option value="priceDesc">Precio â†“</option>
          <option value="newest">Novedades</option>
        </select>
      </label>
    </section>

    <!-- grilla de productos -->
<section class="products" *ngIf="filteredProducts?.length; else emptyState">
  <article class="product-card" *ngFor="let product of pagedProducts; trackBy: trackById">
    <div class="product-media">
      <img
        [ngSrc]="product.image"
        [alt]="product.name"
        width="300"
        height="400"
        loading="lazy" />
    </div>
    <div class="product-info">
      <h3 class="product-name">{{ product.name }}</h3>
      <p class="price">{{ product.price | currency:'USD':'symbol':'1.0-0' }}</p>
      <p class="product-tags">
        <span class="tag">{{ product.category }}</span>
        <span class="tag">{{ product.subCategory }}</span>
        <span class="tag">Talla: {{ product.size }}</span>
        <span class="tag tag-color">Color: {{ product.color }}</span>
      </p>
      <div class="product-actions">
        <button type="button" class="add-to-cart" (click)="addToCart(product)">
          Agregar al carrito
        </button>
      </div>
    </div>
  </article>
</section>

     <ng-template #emptyState>
      <div class="empty-state">
        <p>{{ emptyStateMessage }}</p>
      </div>
    </ng-template>

    <!-- paginaciÃ³n -->
    <nav class="pagination" aria-label="PaginaciÃ³n de productos" *ngIf="filteredProducts?.length">
      <button type="button" (click)="goToPreviousPage()" [disabled]="page === 1">Anterior</button>
      <span>PÃ¡gina {{ page }} de {{ totalPages }}</span>
      <button type="button" (click)="goToNextPage()" [disabled]="page === totalPages">Siguiente</button>
    </nav>
  </main>
</div>

<button
  #cartToggleButton
  type="button"
  class="cart-toggle"
  (click)="toggleCartPanel()"
  [attr.aria-expanded]="isCartPanelOpen"
  aria-controls="catalog-cart-panel">
  <span class="cart-toggle-icon" aria-hidden="true">ðŸ›’</span>
  <span class="cart-toggle-label">Carrito</span>
  <span class="cart-toggle-count" *ngIf="(cartCount$ | async) as count">{{ count }}</span>
</button>

<div
  id="catalog-cart-panel"
  class="cart-panel"
  [class.open]="isCartPanelOpen"
  role="dialog"
  aria-modal="false"
  aria-labelledby="catalog-cart-title"
  [attr.aria-hidden]="!isCartPanelOpen">
  <div class="cart-panel-header">
    <h2 id="catalog-cart-title">Tu carrito</h2>
    <button type="button" class="cart-panel-close" (click)="closeCartPanel()" aria-label="Cerrar carrito">
      Ã—
    </button>
  </div>

  <ng-container *ngIf="(cartItems$ | async) as cartItems">
    <div class="cart-panel-body">
      <ng-container *ngIf="cartItems.length; else emptyCartPanel">
        <article class="cart-panel-item" *ngFor="let item of cartItems; trackBy: trackByCartItem">
          <div class="item-thumb">
            <img [src]="item.product.image" [alt]="item.product.name" loading="lazy" />
          </div>
          <div class="item-info">
            <h3>{{ item.product.name }}</h3>
            <p class="item-meta" *ngIf="item.product.size">Talla: {{ item.product.size }}</p>
            <p class="item-meta" *ngIf="item.product.color">Color: {{ item.product.color }}</p>
            <p class="item-price">{{ item.product.price | currency:'USD':'symbol':'1.0-0' }}</p>
            <div class="item-quantity-control">
              <button
                type="button"
                (click)="decrementCartItem(item.product.id)"
                aria-label="Disminuir cantidad">
                âˆ’
              </button>
              <input
                type="number"
                min="1"
                [value]="item.quantity"
                (change)="updateCartQuantity(item.product.id, $event.target.value)" />
              <button
                type="button"
                (click)="incrementCartItem(item.product.id)"
                aria-label="Aumentar cantidad">
                +
              </button>
            </div>
          </div>
          <button
            type="button"
            class="remove-item"
            (click)="removeCartItem(item.product.id)"
            aria-label="Eliminar producto">
            Ã—
          </button>
        </article>
      </ng-container>
    </div>

    <div class="cart-panel-footer" *ngIf="cartItems.length">
      <div class="cart-panel-subtotal">
        <span>Subtotal</span>
        <strong>{{ (cartTotal$ | async) | currency:'USD':'symbol':'1.0-0' }}</strong>
      </div>
      <p class="cart-panel-note">El envÃ­o y los impuestos se calculan al finalizar la compra.</p>
      <a routerLink="/carrito" class="cart-panel-link" (click)="closeCartPanel()">Ver carrito completo</a>
      <a routerLink="/checkout" class="cart-panel-checkout" (click)="closeCartPanel()">Finalizar compra</a>
    </div>
  </ng-container>
</div>

<ng-template #emptyCartPanel>
  <div class="cart-panel-empty">
    <p>Tu carrito estÃ¡ vacÃ­o. Agrega tus prendas favoritas para verlas aquÃ­.</p>
    <a routerLink="/catalogo" (click)="closeCartPanel()">Explorar catÃ¡logo</a>
  </div>
</ng-template>

<div class="cart-panel-backdrop" *ngIf="isCartPanelOpen" (click)="closeCartPanel()" aria-hidden="true"></div>
