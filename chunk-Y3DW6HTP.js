import{N as m,a,b as s,j as c,q as d}from"./chunk-NNVSBPZR.js";var p=class n{static STORAGE_KEY="dulce_cart_state";itemsSubject=new c(this.loadFromStorage());items$=this.itemsSubject.asObservable();totalQuantity$=this.items$.pipe(d(t=>t.reduce((r,e)=>r+e.quantity,0)));subtotal$=this.items$.pipe(d(t=>t.reduce((r,e)=>r+e.product.price*e.quantity,0)));addItem(t,r=1){if(!t?.id)return;let e=Number.isFinite(r)?Math.max(1,Math.floor(r)):1,i=[...this.itemsSubject.value],o=i.findIndex(u=>u.product.id===t.id);o>-1?i[o]=s(a({},i[o]),{quantity:i[o].quantity+e}):i.push({product:a({},t),quantity:e}),this.persist(i)}updateQuantity(t,r){if(!t)return;let e=Number.isFinite(r)?Math.max(1,Math.floor(r)):1,i=this.itemsSubject.value.map(o=>o.product.id===t?s(a({},o),{quantity:e}):o);this.persist(i)}increment(t){this.modifyQuantity(t,1)}decrement(t){this.modifyQuantity(t,-1)}removeItem(t){if(!t)return;let r=this.itemsSubject.value.filter(e=>e.product.id!==t);this.persist(r)}clearCart(){this.persist([])}modifyQuantity(t,r){if(!t||r===0)return;let e=[...this.itemsSubject.value],i=e.findIndex(u=>u.product.id===t);if(i===-1)return;let o=e[i].quantity+r;o<=0?e.splice(i,1):e[i]=s(a({},e[i]),{quantity:o}),this.persist(e)}persist(t){this.itemsSubject.next(t),this.saveToStorage(t)}loadFromStorage(){if(typeof window>"u"||typeof window.localStorage>"u")return[];try{let t=window.localStorage.getItem(n.STORAGE_KEY);if(!t)return[];let r=JSON.parse(t);return Array.isArray(r)?r.map(e=>({product:a({},e.product),quantity:Number.isFinite(e.quantity)?Math.max(1,Math.floor(e.quantity)):1})).filter(e=>!!e.product?.id):[]}catch(t){return console.error("No se pudo leer el estado del carrito",t),[]}}saveToStorage(t){if(!(typeof window>"u"||typeof window.localStorage>"u"))try{window.localStorage.setItem(n.STORAGE_KEY,JSON.stringify(t))}catch(r){console.error("No se pudo guardar el estado del carrito",r)}}static \u0275fac=function(r){return new(r||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{p as a};
